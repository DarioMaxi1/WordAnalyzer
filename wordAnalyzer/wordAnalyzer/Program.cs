using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Diagnostics;

class Program
{
    static async Task Main()
    {
        Console.InputEncoding = Encoding.UTF8;
        Console.OutputEncoding = Encoding.UTF8;

        string text = "Забола в облачното небе вечно заснежени върхове, високи повече от осем хиляди метра, средната верига на Хималаите изглеждаше непроходима, ала по един от високите й проходи се тътреше търговски керван. Неговият водач Сампо Синги яздеше едър як[1] начело на колоната. Силното животно стъпваше тежко с дебелите си крака, бавно ги местеше, умишлено ги провличаше и правеше пъртина през сипкавия сняг. Следваха ги стотина якове, коне и магарета, натоварени с платове, сечива, ориз, подправки и други стоки, а някои дори яхнати от своите стопани.\r\n\r\nВече дни наред керванът пътуваше от индийското селище Канпур кога по каменисти пътеки, кога без път. Дългото, уморително изкачване бе изтощило животните, но те чувствуваха, че през тоя ден остава още малко да вървят, докато ги спрат за почивка. Затуй напрягаха сили и нито едно не изостана. Всички достигнаха превала, починаха и по северния склон на планината се спуснаха към Тибет. Бяха на шест хиляди метра височина, а само на два километра под тях снегът се бе стопил през лятото и в долината растеше трева. Там се намираше определеното място за нощуване. Щом стигнаха до него, Сампо Синги даде знак на хората да спрат. Разтовариха животните и ги пуснаха да пасат по тясна дълга поляна, просната между езерото Сините очи и високи скали. Изкопаха трапове. Направиха палатки. Застлаха ги с кожи и приготвиха легла за преспиване. За водача, който бе и главатар на охраната, издигнаха отделна палатка.\r\n\r\nВсеки търговец събра стоките си на едно място. Вечеряха и легнаха да спят. Нахрани се и Сампо Синги. Застана пред палатката и хвърли последен поглед наоколо. Слънцето беше залязло. Настъпваше безлунна нощ и по дълбокото небе се показваха едри звезди, но нямаше опасност за нападение на кервана от чергари, защото хора по тия места рядко се мяркаха, а и лагерът бе много добре защитен. От север го пазеше езерото — дълбоко, широко и дълго повече от два километра. Извитите му краища почти допираха стръмните склонове на планинската верига, която се издигаше от юг. Скованите й от лед и сняг върхове бяха непроходими. Между тях зееха дълбоки долини, необитавани от живи същества. Затуй търговците не очакваха нападение от тая страна и спокойно заспаха. Сампо Синги постави двама души за охрана на добитъка, прибра се в палатката, легна и скоро се унесе в сладък сън. Не можа да си представи колко време е спал, когато някой се втурна при него, сграбчи го с двете си ръце, разтърси го силно и простена:\r\n\r\n— Сирдаре, йети[2]!\r\n\r\n— А, йети! — трепна той.\r\n\r\n— Йети, сирдаре.\r\n\r\n— Сигурно си се уплашил от някоя скала?\r\n\r\n— Не съм се уплашил от скала.\r\n\r\nВ Тибет се знаеше, че от Хималаите, та чак до Монголия, там, докъдето лятно време снегът се стопява и расте трева, живеят снежни хора, наричани йети. Керванът нощуваше точно по тия места. Никак не бе чудно, че някой йети, който живее наблизо, е доближил лагера и дебне да открадне нещо за ядене или да убие и отвлече животно. Появяването на един йети не беше страшно за Сампо Синги. Дори десет йети да се появят, пак не ще успеят да отмъкнат нищо от стоките на кервана, ако охраната вдигне оръжие срещу тях. Опасението му идеше от страха на хората. Всеки човек от неговата дружина знаеше поверието, че който види йети, ще бъде сполетян от голямо нещастие. Затуй никой не ще посмее да погледне страшилището, а камо ли да се бие с него. Дори самият той изтръпна, като чу името му, но посегна към сабята си, сграбчи я здраво за дръжката и бързо скочи.\r\n\r\n— Тихо, Анг Ла. Тихо! — рече на коленичилия пазач. — Стани и кажи къде видя йети!\r\n\r\nОще млад и пъргав, Анг Ла бързо се изправи срещу главатаря си. В палатката бе тъмно, та не можа да види лицето му, но разбираше, че е уплашен.\r\n\r\n— До брега на езерото седях — зашушна, — очите ми шарят из лагера, добитъка обикалят. А небето, нали е ясно, всичко се вижда. И чак по време, кога вечерницата се скри зад върховете, мрачината се посгъсти. Тогава, гледам, от скалите скала се откърти. Зачаках да се търкулне и бухне в езерото, а тя първо не мръдна, а после изведнъж се раздвижи. Рекох си — не е скала откъртена, а мечка е скочила. Стиснах пушката да я посрещна, ако поеме насам, а то каква ти мечка, брате — йети. Както се бе сгушил до скалите, просна се по корем, къде-къде по-дълъг от мене, и запълзя насам. Изтръпнах. Помъчих се да извикам — глас не издадох и зъбите ми започнаха да се бият. Не посмях да погледна втори път към йети, не ми се ще беда да ме сполети. И не знам откъде се взеха сили, та и аз като страшилището полазих по корем към палатката да те събудя.\r\n\r\nПреди три години Сампо Синги също видя един йети съвсем неочаквано и много близо. Уплаши се, както се бе уплашил сега Анг Ла. Тогава и той дълго не можа да се успокои и зачака да го сполети голямо нещастие или да се разболее от невярна болест. А ето толкова време мина от тази случка, а лошо не му се случи, нито се разболя. Това го караше да вярва, че нищо няма да го сполети, ако и втори път срещне йети. Но дори и да го чака беда, длъжен е като главатар на охраната да защищава търговците и да прогони снежните хора, колкото и да са те. Не направи ли това, няма да си изпълни задължението, ще се изложи пред търговците, а те няма да му заплатят определеното възнаграждение за охрана на кервана и опазване на стоките им.\r\n\r\n— Ти знаеш, Анг Ла — рече и пристъпи крачка, — ти много добре знаеш, че йети е страхлив, а, според мен, и да го види човек, от това няма да пострада. Затуй аз не се боя нито от среща, нито от двубой с него. И щом казваш, че един си видял, ще го потърся и прогоня.\r\n\r\nПазачът не трепереше вече, ала не му отговори. Сампо Синги излезе бързо из палатката, а той го последва. Вън бе все още безлунна нощ. Наоколо се носеше силен еднообразен шум от буйни пълноводни потоци, често засилван от внезапен трясък на падащи в пропастите ледове, скали и лавини. Животните, пръснати по поляната, бяха спокойни. Сампо Синги тръгна към тях, като продължаваше да държи сабята си вдигната нагоре с едната ръка, а в другата пищов. За него сабята бе най-верен и сигурен другар. Охраната му носеше и пушки, но в тъмнината не можеше да види точно къде е йети и да се прицелва в него, затуй нощно време предпочиташе да носи сабята, защото с нея винаги можеше да се брани отблизо по-сигурно. Не е и сам, Анг Ла го следва и ще му помогне при нужда. Спокойно огледа палатките, купчините стоки на търговците, а не зърна никакъв йети. Само зад крайната палатка съгледа някакво голямо кълбо, което цяло се тресеше. Анг Ла облещи очи и се дръпна назад, като помисли, че това е някое от страшилищата, но Сампо Синги сметна, че е другият човек от лагерната охрана, също видял йети.\r\n\r\n— Дава Тонд — повика тихо, — от какво си се разтреперал?\r\n\r\nТреперещото кълбо наистина бе пазачът. Той отхвърли кожуха, с който бе покрил главата си, няколко минути гледа като втрещен главатаря си и едва когато се увери, че е той, а не някое от страшилищата, престана да трепери и полека се изправи.\r\n\r\n— Ох, главатарю — простена, — свърши се с моето добро. Кой знае какво ще си изпатя, като видях йети.\r\n\r\n— А къде го видя? — попита Сампо Синги.\r\n\r\n— Ей там срещу добитъка. Пълзи насам през поляната. Обърнах се да не го гледам — отгоре пълзи пък друг. Не можах ни да стана, ни да извикам. Завих главата си с кожуха и втори път не погледнах.\r\n\r\n— Те са избягали — рече Сампо Синги. — Не се плашете, че сте ги видели. А сега идете в палатката да спите, но не казвайте нищо за йети. Събудете само Пени Поло — той и още един от охраната да дойдат при мене.\r\n\r\nДвамата пазачи само това чакаха. Веднага се спуснаха към палатката. Скоро Пени Поло се показа с още един човек от охраната. И двамата бяха весели. Сампо Синги също весело ги посрещна, обикаля с тях лагера, докато изгря месецът, и се прибра да поспи, ала сънят му не бе спокоен. Сам се събуди. Очакваше, че всички търговци са научили вече за появяването на йети, но се излъга. Животните лениво преживяха, налягали по тревата на поляната, а хората весело разговаряха и се готвеха за тръгване. Неочаквано един от търговците викна:\r\n\r\n— Липсва ми торба с ориз.\r\n\r\nНеговото оплакване предизвика насмешка по устните на мнозина. Знаеше се кой колко торби ориз кара и ако някой се е опитал да открадне чужда торба, веднага ще я открият. Да я скрие някъде наоколо — кога ще се върне по тези места да я прибере?\r\n\r\n— Мен ми липсват две торби с ориз — обади се друг след него.\r\n\r\nИ нему не повярваха. Накараха и двамата да преброят втори път торбите си, но проверката потвърди оплакванията. Три торби ориз наистина липсваха. Студени тръпки минаха по тялото на Сампо Синги, но той нищо не каза, само схапа устни, въздъхна и погледна към големите скали, които стърчаха в края на поляната. Търговците се поглеждаха един друг, поглеждаха към него и се чудеха кой е откраднал торбите с ориза. Учудването им не трая много. Двама по-ранобудни търговци бяха отишли към скалите да търсят плодове за ядене. Единият от тях се спря по едно време, вгледа се в тревата, изправи глава и викна:\r\n\r\n— Ей, хора, тук има разсипан ориз!\r\n\r\n— Много ли? — попита го Сампо Синги.\r\n\r\nТърговецът погледна към скалите, навярно да провери има ли на друго място ориз, бързо обърна главата си и без да отговори, хукна към лагера. Другарят му се почуди защо бяга, погледна към скалите и хукна след него.\r\n\r\n— Йети. В скалите има снежни хора — пошушнаха и двамата, когато стигнаха в лагера и се поуспокоиха.\r\n\r\nОправда се предположението на Сампо Синги, че йети са отвлекли през нощта торбите с ориза, докато той излезе от палатката си.\r\n\r\n— Йети са откраднали торбите с ориза — въздъхна той. — Пазачите, които оставих снощи на пост, са ги видели, но се уплашили и сигурно, докато дойдоха да ме събудят, страшилищата са избягали. Аз веднага излязох и до зори обикалях, но не ги видях.\r\n\r\nТая новина изплаши търговците, защото и те като всички тибетци вярваха, че ще ги сполети зло, ако видят йети. Затуй мнозина от тях предложиха веднага да натоварят стоките и да се махнат от това място. Никой не отхвърли предложението, ала за да се промъкнат по прохода между езерото и склона на планината, трябваше да минат край скалите, където страшилищата са отмъкнали ориза и се крият, а не се знаеше колко са. От ухо на ухо вече се шушукаше, че не са по-малко от трима, щом липсват три торби ориз. Имаше опасност, когато стигнат до скалите, страшилищата да ги нападнат с камъни в тесния проход, да ги избият и отмъкнат ориза на всички търговци. Чуха се предложения керванът да се върне назад и да търси друг път. Сампо Синги не се съгласи, защото пътят, по който водеше търговците към техните селища, бе най-пряк. За да ги успокои, предложи сам да мине покрай скалите, за да видят всички, че йети не ще посмеят да нападнат един човек, а камо ли целия керван.\r\n\r\nТибетците са средни на ръст, той беше от по-високите. Не знаеше на колко години е, защото тибетският календар няма числа за годините. Всяка година носи името на животно. Редят се последователно дванадесет години — шест с имена на мъжки животни и шест с имена на женски. Изтекат ли те, започва нова поредица на години пак със същите имена. Сампо Синги знаеше, че е роден в годината на тигъра, но не знаеше в коя поредица години. Когато беше малък, бащината му къща се състоеше от черна палатка, направена от плат, изтъкан от козината на домашен як. Тя не стоеше на едно място. Местеха я там, където имаше повече трева за овцете и яковете. После баща му направи къща в селището Тангар и започна да охранява търговски кервани. Сампо ходеше с него. При едно нападение на кервана от чергари баща му бе убит заедно с двама други мъже. Сампо Синги натовари труповете на убитите на един от яковете и ги закара в селището. На другия ден ги изнесоха на близкия връх. Разсякоха ги на късове и ги разхвърлиха по скалите. Местните калугери, които тибетците наричат лами, започнаха да произнасят високо молитви. Долетяха орли, чули гласовете им, нахвърлиха се върху месата на мъртвите, за кратко време ги разкъсаха и парче по парче ги изядоха.\r\n\r\n";
        Console.WriteLine("Choose which version to run:");
        Console.WriteLine("1. Non-threaded");
        Console.WriteLine("2. Multi-threaded");

        string choice = Console.ReadLine();

        if (choice == "1")
        {
            
            var stopwatch = Stopwatch.StartNew();
            var result = AnalyzeText(text);
            stopwatch.Stop();
            DisplayResults(result);
            Console.WriteLine($"Non-threaded version execution time: {stopwatch.ElapsedMilliseconds} ms");
        }
        else if (choice == "2")
        {
            
            var stopwatch = Stopwatch.StartNew();
            var result = await AnalyzeTextThreaded(text);
            stopwatch.Stop();
            DisplayResults(result);
            Console.WriteLine($"Multi-threaded version execution time: {stopwatch.ElapsedMilliseconds} ms");
        }
        else
        {
            Console.WriteLine("Invalid choice. Please choose 1 or 2.");
        }
    }

    static void DisplayResults((int WordCount, string ShortestWord, string LongestWord, double AverageWordLength, List<(string Word, int Count)> MostCommonWords, List<(string Word, int Count)> LeastCommonWords) result)
    {
        Console.WriteLine($"Number of words: {result.WordCount}");
        Console.WriteLine($"Shortest word: {result.ShortestWord}");
        Console.WriteLine($"Longest word: {result.LongestWord}");
        Console.WriteLine($"Average word length: {result.AverageWordLength:F2}");
        Console.WriteLine("Most common words:");
        foreach (var word in result.MostCommonWords)
            Console.WriteLine($"{word.Word}: {word.Count}");
        Console.WriteLine("Least common words:");
        foreach (var word in result.LeastCommonWords)
            Console.WriteLine($"{word.Word}: {word.Count}");
    }

    static List<string> GetWords(string text)
    {
        var cleanedText = new string(text.Where(c => !char.IsPunctuation(c)).ToArray()).ToLower();
        return cleanedText.Split(' ').Where(word => word.Length >= 3).ToList();
    }

    // Non-threaded 
    static (int WordCount, string ShortestWord, string LongestWord, double AverageWordLength, List<(string Word, int Count)> MostCommonWords, List<(string Word, int Count)> LeastCommonWords) AnalyzeText(string text)
    {
        var words = GetWords(text);

        int wordCount = words.Count;
        if (wordCount == 0)
            return (0, "", "", 0, new List<(string, int)>(), new List<(string, int)>());

        string shortestWord = words.OrderBy(word => word.Length).First();
        string longestWord = words.OrderByDescending(word => word.Length).First();
        double averageWordLength = words.Average(word => word.Length);

        var wordFrequencies = words.GroupBy(word => word)
                                   .Select(group => (Word: group.Key, Count: group.Count()))
                                   .OrderByDescending(x => x.Count)
                                   .ToList();

        var mostCommonWords = wordFrequencies.Take(5).ToList();
        var leastCommonWords = wordFrequencies.TakeLast(5).ToList();

        return (wordCount, shortestWord, longestWord, averageWordLength, mostCommonWords, leastCommonWords);
    }

    // Multi-threaded 
    static async Task<(int WordCount, string ShortestWord, string LongestWord, double AverageWordLength, List<(string Word, int Count)> MostCommonWords, List<(string Word, int Count)> LeastCommonWords)> AnalyzeTextThreaded(string text)
    {
        var words = GetWords(text);
        var wordCountTask = Task.Run(() => words.Count);
        var shortestWordTask = Task.Run(() => words.OrderBy(word => word.Length).First());
        var longestWordTask = Task.Run(() => words.OrderByDescending(word => word.Length).First());
        var averageWordLengthTask = Task.Run(() => words.Average(word => word.Length));
        var mostCommonWordsTask = Task.Run(() =>
            words.GroupBy(word => word)
                 .Select(group => (Word: group.Key, Count: group.Count()))
                 .OrderByDescending(x => x.Count)
                 .Take(5)
                 .ToList());
        var leastCommonWordsTask = Task.Run(() =>
            words.GroupBy(word => word)
                 .Select(group => (Word: group.Key, Count: group.Count()))
                 .OrderBy(x => x.Count)
                 .Take(5)
                 .ToList());

        await Task.WhenAll(wordCountTask, shortestWordTask, longestWordTask, averageWordLengthTask, mostCommonWordsTask, leastCommonWordsTask);

        return (wordCountTask.Result, shortestWordTask.Result, longestWordTask.Result, averageWordLengthTask.Result, mostCommonWordsTask.Result, leastCommonWordsTask.Result);
    }
}
